<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LiveKit WebRTC Client</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
    }
    #join-btn {
      padding: 12px 24px;
      font-size: 16px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 20px;
    }
    #join-btn:hover {
      background: #45a049;
    }
    #join-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #leave-btn {
      padding: 12px 24px;
      font-size: 16px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 20px;
      display: none;
    }
    #leave-btn:hover {
      background: #da190b;
    }
    #logs {
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
      list-style: none;
      margin: 0;
    }
    #logs li {
      padding: 5px 0;
      border-bottom: 1px solid #eee;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #666;
    }
    #logs li:last-child {
      border-bottom: none;
    }
    .status {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      background: #e3f2fd;
      color: #1976d2;
    }
    .error {
      background: #ffebee;
      color: #c62828;
    }
    .success {
      background: #e8f5e9;
      color: #2e7d32;
    }
  </style>
</head>
<body>
  <h1>LiveKit Voice Client</h1>
  <div id="status" class="status">Ready to connect</div>
  <button id="join-btn">Join Room</button>
  <button id="leave-btn">Leave Room</button>
  <ul id="logs"></ul>

  <!-- LiveKit Client SDK -->
  <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>

  <script>
    const joinBtn = document.getElementById("join-btn");
    const leaveBtn = document.getElementById("leave-btn");
    const logs = document.getElementById("logs");
    const status = document.getElementById("status");
    let room = null;
    let localStream = null;
    let isConnecting = false;

    // Get or create a persistent user identity
    function getUserIdentity() {
      let identity = sessionStorage.getItem("livekit-identity");
      if (!identity) {
        identity = `user-${Date.now()}`;
        sessionStorage.setItem("livekit-identity", identity);
      }
      return identity;
    }

    function log(msg, type = "info") {
      const li = document.createElement("li");
      const timestamp = new Date().toLocaleTimeString();
      li.textContent = `[${timestamp}] ${msg}`;
      if (type === "error") {
        li.style.color = "#c62828";
      } else if (type === "success") {
        li.style.color = "#2e7d32";
      }
      logs.appendChild(li);
      logs.scrollTop = logs.scrollHeight;
    }

    function updateStatus(msg, className = "status") {
      status.textContent = msg;
      status.className = className;
    }

    async function joinRoom() {
      // Guard: prevent multiple simultaneous connections
      if (isConnecting) {
        log("⚠️ Connection already in progress, ignoring duplicate call", "error");
        return;
      }

      // Guard: if already connected or room exists, disconnect first
      if (room) {
        log("⚠️ Room already exists, disconnecting first...");
        await leaveRoom();
        // Wait a bit for cleanup to complete
        await new Promise(resolve => setTimeout(resolve, 200));
      }

      // Set connecting flag
      isConnecting = true;

      try {
        joinBtn.disabled = true;
        updateStatus("Connecting...", "status");
        log("Requesting token from backend...");

        // Get token from backend server
        const roomName = "my-room";
        const identity = getUserIdentity();
        const resp = await fetch(`http://localhost:8080/api/token?room=${roomName}&identity=${identity}`);
        
        if (!resp.ok) {
          throw new Error(`Failed to get token: ${resp.status} ${resp.statusText}`);
        }

        const { token } = await resp.json();
        log(`Token received for room: ${roomName}, identity: ${identity}`);

        // Connect to LiveKit server
        room = new LivekitClient.Room();
        
        // Handle connection events
        room.on(LivekitClient.RoomEvent.Connected, () => {
          log("Connected to LiveKit room!", "success");
          updateStatus("Connected", "success");
        });

        room.on(LivekitClient.RoomEvent.Disconnected, () => {
          log("Disconnected from room");
          updateStatus("Disconnected", "status");
          joinBtn.disabled = false;
          leaveBtn.style.display = "none";
        });

        room.on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
          log(`Track subscribed: ${publication.trackName} from ${participant.identity}`, "success");
          
          // Attach audio track to DOM and play
          if (track.kind === "audio") {
            const el = track.attach();
            document.body.appendChild(el);
            el.play().catch(err => {
              log(`Error playing audio: ${err.message}`, "error");
            });
          }
        });

        room.on(LivekitClient.RoomEvent.TrackUnsubscribed, (track, publication, participant) => {
          log(`Track unsubscribed: ${publication.trackName} from ${participant.identity}`);
          track.detach();
        });

        room.on(LivekitClient.RoomEvent.ParticipantConnected, (participant) => {
          log(`Participant connected: ${participant.identity}`, "success");
        });

        room.on(LivekitClient.RoomEvent.ParticipantDisconnected, (participant) => {
          log(`Participant disconnected: ${participant.identity}`);
        });

        // Use LiveKit Cloud URL (matches backend configuration)
        const livekitUrl = "wss://fdsf-4jf93oez.livekit.cloud";
        log(`Connecting to LiveKit server at ${livekitUrl}...`);
        await room.connect(livekitUrl, token);
        log("Connection established!", "success");

        // Request microphone access
        log("Requesting microphone access...");
        localStream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          } 
        });
        const audioTrack = localStream.getAudioTracks()[0];
        log(`Microphone acquired: ${audioTrack.label}`, "success");

        // Publish microphone track
        log("Publishing microphone to room...");
        await room.localParticipant.publishTrack(audioTrack, {
          name: "mic",
          source: LivekitClient.Track.Source.Microphone,
        });

        log("Microphone published successfully! You can now speak.", "success");
        updateStatus("Connected - Microphone active", "success");
        leaveBtn.style.display = "inline-block";

      } catch (error) {
        log(`Error: ${error.message}`, "error");
        updateStatus(`Error: ${error.message}`, "error");
        joinBtn.disabled = false;
        leaveBtn.style.display = "none";
        
        // Clean up on error
        if (room) {
          try {
            await room.disconnect();
          } catch (e) {
            // Ignore disconnect errors during error handling
          }
          room = null;
        }
        if (localStream) {
          localStream.getTracks().forEach(track => track.stop());
          localStream = null;
        }
      } finally {
        // Always clear connecting flag
        isConnecting = false;
      }
    }

    async function leaveRoom() {
      // Clear connecting flag if we're disconnecting
      isConnecting = false;

      try {
        if (localStream) {
          localStream.getTracks().forEach(track => track.stop());
          localStream = null;
        }

        if (room) {
          await room.disconnect();
          room = null;
        }

        log("Left room and stopped microphone", "success");
        updateStatus("Disconnected", "status");
        joinBtn.disabled = false;
        leaveBtn.style.display = "none";
      } catch (error) {
        log(`Error leaving room: ${error.message}`, "error");
      }
    }

    joinBtn.onclick = joinRoom;
    leaveBtn.onclick = leaveRoom;
  </script>
</body>
</html>

